## stlatica ログ設計

### 概要
Stlaticaバックエンドにおけるログの設計
目的はエラー調査・パフォーマンスの確認・デバッグ確認（開発用）
書き出すログは絞り込みがしやすいように構造化する

### ログ方針
- リクエスト・クエリみたいな大量に書き込みがありそうなものはログの書き出し先を分ける
- 分けたログの連携はできるように共通のログIDを設定

### フォーマット
JSON  
→ 他サービスとも連携しやすく、大体の人がわかるフォーマットであるため


###　ログの種類
- リクエストログ ... Httpリクエスト収集
- クエリログ ... SQLクエリ収集
- アプリケーションエラーログ ... サーバエラー収集
- アプリケーションログ ... エラー以外のもろもろ、システムログと呼んでもいい

### ログの保存先
まずは外部（クラウドサービスやウェブサービス）連携を必要としない構成を優先  
→ ローカルのログファイル　+ NoSQL(ElasticSearch)

以下詳細 

- ローカルのログファイル(採用)
    - ローカルで完結できる。簡単な調査はここを見るだけでよい
    - tail -f とかでログを流し見できる
    - ログローテーション(logrotate)して1ファイルを大きくさせすぎない
    （"myapp-Y-m-d.log"みたいに命名,つまり日毎）

- NoSQL(ElasticSerch)(採用?)
    - RDBより書き込みのパフォーマンス面が優位
    - データの肥大化に対するアプローチもあるっぽい
        - ローテーション, リストア, ライフサイクル設定とか
    - 構造化データを扱える
    - EasticSearchだと検索とかもしやすいらしい
    - ElasticSearchを使うにしろ専用の知識はいる

- RDB(mySQLとか)(多分不採用)
    - 構造化データを扱える
    - SQLのいいところが使える（クエリ文,index,partitionとか）
    - 書き込みが多くなりやすいのでパフォーマンスが心配
    - データ肥大化に対して対応は必要

- 外部連携
    - Cloud Watch Logs(候補)
        - ローカルのログファイルを設定する
            - ローテーションは"myapp-*.log"みたいにして監視できるはず
        - 個人的には使いやすい
        - お金かかる 
    - Rollbar(候補)
        - ログの収集というよりエラーや例外をモニタリングするものっぽい（知見あまりない...）
        - お金かかる

### ログのバックアップ
- ローカルのログファイル
    - ログローテーションしたファイルを圧縮して残すようにする
- 外部ストレージサービス（S3とかGCS）
    - ローカルのログファイルとか, NoSQLとかRDBSとかみんないい感じに切り出して放り込んでおけばいいんじゃないですかね 

### ログの保持期間
外部ストレージに放り込む場合、そのバックアップはずっと残す。  
そしてログファイルやNoSQL/RDBは実際に書き込まれる量次第で考える（決め打ちするなら3ヶ月とか1年とか）

### ログレベル
アプリケーションログ系では意味があるがそれ以外ではあまり意識しない
- リクエストログ ...　なし(設定するならINFO)
- クエリログ ... なし(設定するならINFO)
- アプリケーションエラーログ
    - ERROR : エラーメッセージを表記
    - TRACE : トレース（エラーメッセージを数行に分けるなら使う）
- アプリケーションログ 
    - INFO : 開発用じゃなくても必要なもの。例えばバッチのログとか他システムとの連携に関するログとかあれば
    - DEBUG : 開発用に追加するもの。


### 必須ログパラメータ
共通＋各イベントごとのパラメータを設定

### 共通
- ログID
    - 同タイミングで発生した各種ログを紐付けやすくする  
    （ログイベントごとに書き出しファイル変えることもある設計のため）
    - 順番に並んでくれているとうれしい気がするのでULIDとか?
- timestamp

### リクエストログ
- actor_id (とれないときは0とかにする)

### クエリログ
- クエリ内容
- 実行時間

### アプリケーション(エラー)ログ
- ログレベル
- エラーコード
- メッセージ
- apiURL（エンドポイント）(バッチ処理とか内部処理のエラーなら空)
- actor_id (とれないときは0とかにする)
- IP 
- リクエストパラメータ
    - あるとよいけど負荷にはなりそうなので ON/OFFできてもいいかも

### フロントエンド側エラーログ
- actor_id (とれないときは0とかにする)
- 文字列 (エラーメッセージ)

### 機密情報の取り扱い（maskingなど）
どんな情報を扱うか、参照の必要性に応じてするしないの判断は都度したほうがいい気がする（あまり考えが及んでいないともいう）一旦の方針は下記
- 完全にわからなくすべきものは適当な文字に置き換える
- ある程度区別はつけたいみたいなシチュエーションのとき(IPとか?)は一方向ハッシュをかける




